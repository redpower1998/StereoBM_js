<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>StereoBM</title>

    <script id="bm_worker" type="text/javascript" charset="utf-8">

        var color_map = [0x000080, 0x000084, 0x000089, 0x00008d, 0x000092, 0x000096, 0x00009b, 0x00009f, 0x0000a4, 0x0000a8, 0x0000ad, 0x0000b2, 0x0000b6, 0x0000bb, 0x0000bf, 0x0000c4, 0x0000c8, 0x0000cd, 0x0000d1, 0x0000d6, 0x0000da, 0x0000df, 0x0000e3, 0x0000e8, 0x0000ed, 0x0000f1, 0x0000f6, 0x0000fa, 0x0000ff, 0x0000ff, 0x0000ff, 0x0000ff, 0x0000ff, 0x0004ff, 0x0008ff, 0x000cff, 0x0010ff, 0x0014ff, 0x0018ff, 0x001cff, 0x0020ff, 0x0024ff, 0x0028ff, 0x002cff, 0x0030ff, 0x0034ff, 0x0038ff, 0x003cff, 0x0040ff, 0x0044ff, 0x0048ff, 0x004cff, 0x0050ff, 0x0054ff, 0x0058ff, 0x005cff, 0x0060ff, 0x0064ff, 0x0068ff, 0x006cff, 0x0070ff, 0x0074ff, 0x0078ff, 0x007cff, 0x0080ff, 0x0084ff, 0x0088ff, 0x008cff, 0x0090ff, 0x0094ff, 0x0098ff, 0x009cff, 0x00a0ff, 0x00a4ff, 0x00a8ff, 0x00acff, 0x00b0ff, 0x00b4ff, 0x00b8ff, 0x00bcff, 0x00c0ff, 0x00c4ff, 0x00c8ff, 0x00ccff, 0x00d0ff, 0x00d4ff, 0x00d8ff, 0x00dcfe, 0x00e0fb, 0x00e4f8, 0x02e8f4, 0x06ecf1, 0x09f0ee, 0x0cf4eb, 0x0ff8e7, 0x13fce4, 0x16ffe1, 0x19ffde, 0x1cffdb, 0x1fffd7, 0x23ffd4, 0x26ffd1, 0x29ffce, 0x2cffca, 0x30ffc7, 0x33ffc4, 0x36ffc1, 0x39ffbe, 0x3cffba, 0x40ffb7, 0x43ffb4, 0x46ffb1, 0x49ffad, 0x4dffaa, 0x50ffa7, 0x53ffa4, 0x56ffa0, 0x5aff9d, 0x5dff9a, 0x60ff97, 0x63ff94, 0x66ff90, 0x6aff8d, 0x6dff8a, 0x70ff87, 0x73ff83, 0x77ff80, 0x7aff7d, 0x7dff7a, 0x80ff77, 0x83ff73, 0x87ff70, 0x8aff6d, 0x8dff6a, 0x90ff66, 0x94ff63, 0x97ff60, 0x9aff5d, 0x9dff5a, 0xa0ff56, 0xa4ff53, 0xa7ff50, 0xaaff4d, 0xadff49, 0xb1ff46, 0xb4ff43, 0xb7ff40, 0xbaff3c, 0xbeff39, 0xc1ff36, 0xc4ff33, 0xc7ff30, 0xcaff2c, 0xceff29, 0xd1ff26, 0xd4ff23, 0xd7ff1f, 0xdbff1c, 0xdeff19, 0xe1ff16, 0xe4ff13, 0xe7ff0f, 0xebff0c, 0xeeff09, 0xf1fc06, 0xf4f802, 0xf8f500, 0xfbf100, 0xfeed00, 0xffea00, 0xffe600, 0xffe200, 0xffde00, 0xffdb00, 0xffd700, 0xffd300, 0xffd000, 0xffcc00, 0xffc800, 0xffc400, 0xffc100, 0xffbd00, 0xffb900, 0xffb600, 0xffb200, 0xffae00, 0xffab00, 0xffa700, 0xffa300, 0xff9f00, 0xff9c00, 0xff9800, 0xff9400, 0xff9100, 0xff8d00, 0xff8900, 0xff8600, 0xff8200, 0xff7e00, 0xff7a00, 0xff7700, 0xff7300, 0xff6f00, 0xff6c00, 0xff6800, 0xff6400, 0xff6000, 0xff5d00, 0xff5900, 0xff5500, 0xff5200, 0xff4e00, 0xff4a00, 0xff4700, 0xff4300, 0xff3f00, 0xff3b00, 0xff3800, 0xff3400, 0xff3000, 0xff2d00, 0xff2900, 0xff2500, 0xff2200, 0xff1e00, 0xff1a00, 0xff1600, 0xff1300, 0xfa0f00, 0xf60b00, 0xf10800, 0xed0400, 0xe80000, 0xe40000, 0xdf0000, 0xda0000, 0xd60000, 0xd10000, 0xcd0000, 0xc80000, 0xc40000, 0xbf0000, 0xbb0000, 0xb60000, 0xb20000, 0xad0000, 0xa80000, 0xa40000, 0x9f0000, 0x9b0000, 0x960000, 0x920000, 0x8d0000, 0x890000, 0x840000, 0x800000];


        function worker_bm(left_Mat, right_Mat) {
            var left_ImageGray = cvtColorRGBA2Gray(left_Mat);
            var left_ImageSobel = sobel(left_ImageGray);

            var right_ImageGray = cvtColorRGBA2Gray(right_Mat);
            var right_ImageSobel = sobel(right_ImageGray);

            var left = left_bm(left_ImageSobel, right_ImageSobel);
            var right = right_bm(left_ImageSobel, right_ImageSobel);

            var disp_out = left_right_check(left, right);

            var disp = cvtColorGray2RGBA_ColorMap(disp_out);

            return disp;
        }
        function Image_RGBA(_row, _col, _data, _buffer) {
            this.row = _row || 0;
            this.col = _col || 0;
            this.buffer = _buffer || new ArrayBuffer(_row * _col * 4);
            this.data = new Uint8ClampedArray(this.buffer);
            _data && this.data.set(_data);
        }
        function Image_GRAY(_row, _col, _data, _buffer) {
            this.row = _row || 0;
            this.col = _col || 0;
            this.buffer = _buffer || new ArrayBuffer(_row * _col);
            this.data = new Uint8ClampedArray(this.buffer);
            _data && this.data.set(_data);
        }
        function cvtColorRGBA2Gray(_src) {
            var row = _src.row,
                col = _src.col;
            var dst = new Image_GRAY(row, col);
            data = dst.data;
            data2 = _src.data;
            for (i = 0; i < _src.row * _src.col * 4; i++) {
                data[i] = (data2[i * 4] * 299 + data2[i * 4 + 1] * 587 + data2[i * 4 + 2] * 114) / 1000;
            }
            return dst;
        }
        function cvtColorGray2RGBA(_src) {
            var row = _src.row,
                col = _src.col;
            var dst = new Image_RGBA(row, col);
            data = dst.data;
            data2 = _src.data;
            for (i = 0; i < _src.row * _src.col * 4;) {
                data[i++] = data2[i / 4];
                data[i++] = data2[i / 4];
                data[i++] = data2[i / 4];
                data[i++] = 255;
            }
            return dst;
        }
        function cvtColorGray2RGBA_ColorMap(_src) {
            var row = _src.row,
                col = _src.col;
            var dst = new Image_RGBA(row, col);
            data = dst.data;
            data2 = _src.data;
            for (i = 0; i < _src.row * _src.col * 4;) {

                var pix = data2[i / 4];
                var color_val = color_map[pix];
                data[i++] = color_val & 0x00ff0000;
                data[i++] = color_val & 0x0000ff00;
                data[i++] = color_val & 0x000000ff;
                data[i++] = 255;
            }
            return dst;
        }
        function sobel(_src) {
            var SOBEL_CAP = 34;
            var height = _src.row;
            var width = _src.col;
            var in_image = _src.data;
            var dst = new Image_GRAY(height, width);
            var out_image = dst.data;
            for (y = 1; y < height - 1; y++) {
                for (x = 1; x < width - 1; x++) {
                    var val = ((in_image[width * (y - 1) + x + 1] - in_image[width * (y - 1) + x - 1]) +
                        (in_image[width * y + x + 1] - in_image[width * y + x - 1]) * 2 +
                        (in_image[width * (y + 1) + x + 1] - in_image[width * (y + 1) + x - 1]));

                    if (val > SOBEL_CAP)
                        val = SOBEL_CAP;
                    else if (val < -SOBEL_CAP)
                        val = -SOBEL_CAP;

                    out_image[width * y + x] = val + SOBEL_CAP;
                }
            }
            return dst;
        }

        function left_bm(left_src, right_src) {

            var height = left_src.row;
            var width = left_src.col;
            var halfWindow = 5;
            var dst = new Image_GRAY(height, width);
            var dispL = dst.data;
            var NumDisparity = 128;
            var INVALID_DISP_VAL = 0;

            var imgL = left_src.data;
            var imgR = right_src.data;

            for (y = halfWindow; y < height - halfWindow; y++) {
                for (x = halfWindow; x < width - halfWindow; x++) {
                    var min_costL = 32767;
                    dispL[y * width + x] = INVALID_DISP_VAL;
                    for (d = 0; d < Math.min(x - halfWindow, NumDisparity); d++) {
                        var win_cost = 0;
                        var diff = 0;
                        for (y1 = y - halfWindow; y1 <= y + halfWindow; y1++) {
                            for (x1 = x - halfWindow; x1 <= x + halfWindow; x1++) {
                                diff = Math.abs(imgL[y1 * width + x1] - imgR[y1 * width + x1 - d]);
                                win_cost += Math.abs(diff);
                            }
                        }
                        if (win_cost < min_costL) {
                            min_costL = win_cost;
                            dispL[y * width + x] = d;
                        }
                    }
                }
            }
            return dst;
        }

        function right_bm(left_src, right_src) {
            var height = left_src.row;
            var width = left_src.col;
            var halfWindow = 5;
            var dst = new Image_GRAY(height, width);
            var dispR = dst.data;
            var NumDisparity = 128;
            var INVALID_DISP_VAL = 0;

            var imgL = left_src.data;
            var imgR = right_src.data;

            for (y = halfWindow; y < height - halfWindow; y++) {
                for (x = halfWindow; x < width - halfWindow; x++) {
                    var min_costL = 32767;
                    dispR[y * width + x] = INVALID_DISP_VAL;
                    for (d = 0; d < Math.min(width - x - halfWindow, NumDisparity); d++) {
                        var win_cost = 0;
                        var diff = 0;
                        for (y1 = y - halfWindow; y1 <= y + halfWindow; y1++) {
                            for (x1 = x - halfWindow; x1 <= x + halfWindow; x1++) {
                                diff = Math.abs(imgR[y1 * width + x1] - imgL[y1 * width + x1 + d]);
                                win_cost += Math.abs(diff);
                            }
                        }
                        if (win_cost < min_costL) {
                            min_costL = win_cost;
                            dispR[y * width + x] = d;
                        }
                    }
                }
            }
            return dst;
        }
        function left_right_check(left_src, right_src) {
            var height = left_src.row;
            var width = left_src.col;
            var dst = new Image_GRAY(height, width);

            var disp = dst.data;
            var INVALID_DISP_VAL = 0;

            var disp_left = left_src.data;
            var disp_right = right_src.data;

            for (y = 0; y < height; y++) {
                for (x = 0; x < width; x++) {
                    disp[y * width + x] = disp_left[y * width + x] * 2;
                    var left = disp_left[y * width + x];
                    if (x - left > 0) {
                        var right = disp_right[y * width + x - left];
                        var dispDiff = Math.abs(left - right);
                        if (dispDiff > 1)
                            disp[y * width + x] = 0;

                    }
                }
            }
            return dst;
        }


        self.addEventListener("message", function (e) {
            var left_Mat = e.data[0];
            var right_Mat = e.data[1];
            var out_disp = worker_bm(left_Mat, right_Mat);
            postMessage(out_disp);
        }, false);
    </script>
    <script type="text/javascript" charset="utf-8">

        function imread(_image) {
            var width = _image.width,
                height = _image.height;
            var canvas = document.createElement('canvas');
            canvas.width = width;
            canvas.height = height;
            canvas.id = "temp_canvas";

            canvas.getContext("2d").drawImage(_image, 0, 0);
            var imageData = canvas.getContext("2d").getImageData(0, 0, width, height),
                tempMat = new Image_RGBA(height, width, imageData.data);
            imageData = null;
            canvas.getContext("2d").clearRect(0, 0, width, height);
            canvas = null;
            return tempMat;
        }
        function StereoBM(left_Canvas, left_url, right_url) {
            this.left_canvas = left_Canvas;

            this.left_Ctx = this.left_canvas.getContext("2d");
            this.left_url = left_url;
            this.right_url = right_url;

            var _this = this;
            var is_left_ok = false;
            var is_right_ok = false;
            var left_img = new Image();
            left_img.onload = function () {
                is_left_ok = true;
                if (is_right_ok) {
                    do_bm(left_img, right_img);
                }
            };
            left_img.src = this.left_url;

            var right_img = new Image();
            right_img.onload = function () {

                is_right_ok = true;
                if (is_left_ok) {
                    do_bm(left_img, right_img);
                }
            }
            right_img.src = _this.right_url;

            function do_bm(left_img, right_img) {
                var _this = this;
                var left_Mat = imread(left_img);
                var right_Mat = imread(right_img);

                var bm_blob = new Blob([document.querySelector('#bm_worker').textContent]);
                var bm_url = window.URL.createObjectURL(bm_blob);
                worker = new Worker(bm_url);
                var msg = new Array(left_Mat, right_Mat);
                worker.postMessage(msg);
                document.getElementById("info_message").innerHTML = "Start BM, it may take a long time, please wait patiently......";
                worker.onmessage = function (event) {
                    var left_ImageRGBA = event.data;
                    _this.left_canvas.width = left_Mat.col;
                    _this.left_canvas.height = left_Mat.row;

                    imageData = _this.left_Ctx.createImageData(left_Mat.col, right_Mat.row);
                    imageData.data.set(left_ImageRGBA.data);

                    _this.left_Ctx.putImageData(imageData, 0, 0);
                    document.getElementById("info_message").innerHTML = "Done!";
                    worker.terminate();
                    worker = undefined;
                };

            }
        }

    </script>
</head>

<body>
    <div>
        Left Image: <input type="file" name="file" id="left_img_file_id" />
        <br>
        Right Image: <input type="file" name="file" id="right_img_file_id" />
        <br>
        <button type="submit" name="btn" value="提交" id="btnId" onclick="begin_bm()">Begin</button>

    </div>
    <canvas id="left_canvas" width="200" height="100"></canvas>
    <canvas id="right_canvas" width="200" height="100"></canvas>
    <br>
    <canvas id="disp_image" width="200" height="100"></canvas>
    <br>
    <div id="info_message">Binocular block matching algorithm, please select left and right image files</div>
    <script type="text/javascript" charset="utf-8">

        function begin_bm() {

            const leftobjFile = document.getElementById('left_img_file_id')
            if (leftobjFile.value === '') {
                alert('Please select the left image file!')
                return
            }
            const rightobjFile = document.getElementById('right_img_file_id')
            if (rightobjFile.value === '') {
                alert('Please select the right image file!')
                return
            }
            var left_Canvas = document.getElementById("disp_image");

            var left_reader = new FileReader();
            left_reader.readAsDataURL(leftobjFile.files[0]);
            var right_reader = new FileReader();
            right_reader.readAsDataURL(rightobjFile.files[0]);
            var is_left_ok = false;
            var is_right_ok = false;
            left_reader.onload = function (e) {
                show_canvas(document.getElementById('left_canvas'), left_reader.result);
                is_left_ok = true;
                if (is_right_ok) {
                    StereoBM(left_Canvas, left_reader.result, right_reader.result);
                }
            }
            right_reader.onload = function (e) {
                show_canvas(document.getElementById('right_canvas'), right_reader.result);
                is_right_ok = true;
                if (is_left_ok) {
                    StereoBM(left_Canvas, left_reader.result, right_reader.result);
                }
            }

            function show_canvas(canvas, dataUrl) {
                var ctx = canvas.getContext('2d');
                var img = new Image();
                img.onload = function () {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0, img.width, img.height);
                }
                img.src = dataUrl;
            }
        }

    </script>
</body>

</html>